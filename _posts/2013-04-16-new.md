---
layout: post
title: "Hello wolrd"
date: 2013-04-16 13:45:32 +0000
published: true
tags:
---

<!doctype html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--> 	
<html lang="en"> 
<!--<![endif]-->
  <head>
    <meta charset="utf-8" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />	<!-- Force Latest IE rendering engine -->
    <title>Unity: Automate Post Process</title>

    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->


    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,600' rel='stylesheet' type='text/css'>
    <link href="http://feeds2.feedburner.com/tu0huang" rel="alternate" title="Tuo" type="application/atom+xml" /> 
    <link rel="shortcut icon" href="/static/images/favicon.png" />

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 

    <link rel="stylesheet" href="/static/css/style.css">

    <!--[if IE 7]>
      <script src="/static/css/font-awesome-ie7.css"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">	
      <div id='mobile' class='two columns hidden'>
        <ul>
          <li><a href='/'>tuohuang</a></li>
          <li><span class="gray">Tuo Huang 黄拓</span></li>
          <li><a href="mailto:clarkhtse@gmail.com.com">clarkhtse@gmail.com.com</a></li>
          <li><a href="http://twitter.com/tu0huang">@tu0huang</a></li>
        </ul>
      </div>

      <div class="four columns sidebar">
        <section>
          <a id="avatar" href="/"></a>

          <ul id="social">
            <li>
              <a href="mailto:clarkhtse@gmail.com?subject=hi" class="icon-envelope-alt" title="Say hi"></a>
            </li>

            <li>
              <a href="http://twitter.com/tu0huang" class="icon-twitter" title="You should follow me" style="font-size: 28px;"></a>
            </li>

            <li>
              <a href="http://github.com/tuo" class="icon-github"  title="I share and fork code here"></a>
            </li>
            <li>
              <a href="http://feeds2.feedburner.com/tu0huang" class="icon-rss" onClick="_gaq.push(['_trackEvent', 'Link', 'Click', 'Sidebar RSS']);" title="RSS"></a>
            </li>
          </ul>

          <ul id="me">
            <li>Tuo Huang 黄拓</span><a href="http://weibo.com/tu0huang" style="display:inline-block;"><img src='/static/images/sinaweibo.png'/></a></li>
            <li class="gray">iOS and Android developer.</li>
          </ul>

        </section>
      </div>

      <article class='ten columns offset-by-four' id="article-content">
  <header class="ten columns" id="article-header">
    <h1>Unity: Automate Post Process</h1>
  </header>

  <div class='ten columns gray' id="date-header">
    <p>
      Apr 11, 2013
  
    </p>

  </div>

  <div class="ten columns" id="article-content">
    <p>Everytime after I build a Xcode project from Unity for <a href="http://reigngames.com/pigrush/">PigRush</a>, I need to manually link some system frameworks, some third-party frameworks, add my native code and change some build settings. It is really a pain in the ass. After struggling with Unity&rsquo;s Build Player Pipeline, finally I got process automated. The problems I found during process should cover lots of scenarios you probably will run into and hopefully this will give you some lights :)</p>

<h2 id="case-intro">Case Intro</h2>
<p>So I have custom libraries and native code reside under <em>~/UnityWorkspace/PigRush-iOS/Assets/ObjC</em>, which includes following file structure:</p>

<pre><code>├── Chartboost
│   ├── CBAnalytics.h
│   ├── CBAnalytics.h.meta
│   ├── Chartboost.h
│   ├── Chartboost.h.meta
│   ├── libChartboost.a
│   └── libChartboost.a.meta
├── Chartboost.meta
├── FlurryAnalytics
│   ├── FlurryAnalytics.h
│   ├── FlurryAnalytics.h.meta
│   ├── libFlurryAnalytics.a
│   └── libFlurryAnalytics.a.meta
├── FlurryAnalytics.meta
├── RevMobAds.framework
│   ├── Headers -&gt; Versions/Current/Headers
│   ├── Resources -&gt; Versions/Current/Resources
│   ├── RevMobAds -&gt; Versions/Current/RevMobAds
│   ├── Versions
├── PigRushNavtiveCode
│   ├── Appirater.h
│   ├── Appirater.h.meta
│   ├── Appirater.m
│   ├── Appirater.m.meta
│   ├── EmailComposer.h
│   ├── EmailComposer.h.meta
│   ├── EmailComposer.m
│   ├── EmailComposer.m.meta
│   ├── …blablabla
│   ├── UnityNativeManager.h
│   ├── UnityNativeManager.h.meta
│   ├── UnityNativeManager.mm
│   └── UnityNativeManager.mm.meta
</code></pre>

<p>The file structure above is not all, it is part of it.</p>

<p>And the post build process that I&rsquo;m handling is like following:</p>

<ol>
  <li>Import the system frameworks
    <ul>
      <li>Accounts.framework (<em>optional</em>) </li>
      <li>GameKit.framework (<em>optional</em>)</li>
      <li>MessageUI.framework</li>
      <li>MobileCoreServices.framework</li>
      <li>StoreKit.famework</li>
      <li>Social.framework (<em>optional</em>)</li>
      <li>libsqlite3.dylib</li>
    </ul>
  </li>
  <li>Drag into the project all files and folders I listed above from <em>~/UnityWorkspace/PigRush-iOS/Assets/ObjC</em>
    <ul>
      <li>run <em>find . -name &lsquo;</em>.meta&rsquo; -type f -delete* to delete .meta files first</li>
    </ul>
  </li>
  <li>
    <p>Modify <em>AppController.h</em> to add following instance variable declarations for UrbanArship push notification</p>

    <pre><code> NSString *deviceToken;
 NSString *deviceAlias;
 NSString *pushActionURL;    
</code></pre>
  </li>
  <li>
    <p>Modify <em>AppController.mm</em> to add header imports</p>

    <pre><code> #import "Appirater.h"
 #import "RDGameCenterManager.h"
 #import "Chartboost.h"
 #import &lt;RevMobAds/RevMobAds.h&gt;
</code></pre>
  </li>
  <li>
    <p>Modify <em>AppController.mm</em> to add <em>[[RDGameCenterManager sharedInstance] disconnectLocalPlayer];</em> to end of <em>applicationWillResignActive</em> method </p>
  </li>
  <li>
    <p>Modify <em>AppController.mm</em> to add <em>[Appirater appEnteredForeground:YES];</em> to end of <em>applicationWillEnterForeground</em> method </p>
  </li>
  <li>
    <p>Modify <em>AppController.mm</em>  to add other code snippets </p>
  </li>
  <li>Finally set <em>GCC_ENABLE_OBJC_EXCEPTIONS</em> to <em>YES</em> in BuildSettings</li>
</ol>

<p>Imagine everytime, you build from Unity and you have to do those steps, it is very paninful process.</p>

<h2 id="solution">Solution</h2>

<p>Note: You can find complete code in my github repo: <a href="https://github.com/tuo/UnityAutomatePostProcess">UnityAutomatePostProcess</a>.</p>

<p>As Unity <a href="http://docs.unity3d.com/Documentation/ScriptReference/PostProcessBuildAttribute.html">PostProcessBuildAttribute</a> reference says, </p>

<blockquote>
  <p>Add this attribute to a method to get a notification just after building the player.</p>
</blockquote>

<p>&ndash; which means that we can use this meta tag to register with Unity engine to kick off post build process.Also notice:</p>

<blockquote>
  <p>This is an editor class. To use it you have to place your script in Assets/Editor inside your project folder. </p>
</blockquote>

<p>Pretty straightforward. </p>

<p>Given that we&rsquo;re gonna play around xcode project file, it looks like using python is good option(as it is built-in supported on Mac). So what this callback script is just simply calling our <em>post_process.py</em>. We create a file <em>CustomPostprocessScript.cs</em> under <em>~/UnityWorkspace/PigRush-iOS/Assets/Editor</em>:</p>

<div class="highlight"><pre><code class="csharp">    <span class="cp">#if UNITY_IPHONE</span>
<span class="k">using</span> <span class="nn">UnityEngine</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">UnityEditor.Callbacks</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Diagnostics</span><span class="p">;</span>

<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomPostprocessScript</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>
<span class="na">	[PostProcessBuild]</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OnPostprocessBuild</span><span class="p">(</span><span class="n">BuildTarget</span> <span class="n">target</span><span class="p">,</span> <span class="kt">string</span> <span class="n">pathToBuildProject</span><span class="p">)</span>
	<span class="p">{</span>        
		<span class="n">UnityEngine</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;----Custome Script---Executing post process build phase.&quot;</span><span class="p">);</span> 		
		<span class="kt">string</span> <span class="n">objCPath</span> <span class="p">=</span> <span class="n">Application</span><span class="p">.</span><span class="n">dataPath</span> <span class="p">+</span> <span class="s">&quot;/ObjC&quot;</span><span class="p">;</span>
		<span class="n">Process</span> <span class="n">myCustomProcess</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Process</span><span class="p">();</span>		
		<span class="n">myCustomProcess</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="s">&quot;python&quot;</span><span class="p">;</span>
        <span class="n">myCustomProcess</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">Arguments</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Assets/Editor/post_process.py \&quot;{0}\&quot; \&quot;{1}\&quot;&quot;</span><span class="p">,</span> <span class="n">pathToBuildProject</span><span class="p">,</span> <span class="n">objCPath</span><span class="p">);</span>
        <span class="n">myCustomProcess</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">UseShellExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">myCustomProcess</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">RedirectStandardOutput</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
		<span class="n">myCustomProcess</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span> 
		<span class="n">myCustomProcess</span><span class="p">.</span><span class="n">WaitForExit</span><span class="p">();</span>
		<span class="n">UnityEngine</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;----Custome Script--- Finished executing post process build phase.&quot;</span><span class="p">);</span>  		
       
	<span class="p">}</span>
<span class="p">}</span>
    <span class="cp">#endif</span>
</code></pre></div>

<p>Here the <em>pathToBuildProject</em> is like <em>~/UnityWorkspace/XCode/PigRush-XCode</em> and <em>objCPath</em> is the path referring to the folder that our custom libraries and native code reside in(<em>~/UnityWorkspace/PigRush-iOS/Assets/ObjC</em>).</p>

<p>Then we dive into our magic <em>post_process.py</em> script.</p>

<div class="highlight"><pre><code class="python"><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">argv</span>
<span class="kn">from</span> <span class="nn">mod_pbxproj</span> <span class="kn">import</span> <span class="n">XcodeProject</span>
<span class="kn">import</span> <span class="nn">appcontroller</span>
<span class="n">path</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">fileToAddPath</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="c">#path: /Users/tuo/UnityWorkspace/XCode/PigRush-XCode-Test1    </span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;post_process.py xcode build path --&gt; &#39;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">&#39;post_process.py third party files path --&gt; &#39;</span> <span class="o">+</span> <span class="n">fileToAddPath</span><span class="p">)</span>    
    <span class="c">#Before execute this, you better add a check to see whether your change already exist or not, as if user</span>
    <span class="n">select</span> <span class="o">*</span><span class="n">Append</span><span class="o">*</span> <span class="n">rather</span> <span class="n">than</span> <span class="o">*</span><span class="n">Replace</span><span class="o">*</span> <span class="ow">in</span> <span class="n">Unity</span> <span class="n">when</span> <span class="n">build</span><span class="p">,</span> <span class="n">this</span> <span class="n">will</span> <span class="n">save</span> <span class="n">you</span> <span class="n">time</span> <span class="ow">and</span> <span class="n">avoid</span> <span class="n">duplicates</span><span class="o">.</span> 
    
<span class="k">print</span><span class="p">(</span><span class="s">&#39;Step 1: add system libraries &#39;</span><span class="p">)</span>
    <span class="c">#if framework is optional, add `weak=True`</span>
<span class="n">project</span> <span class="o">=</span> <span class="n">XcodeProject</span><span class="o">.</span><span class="n">Load</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span><span class="s">&#39;/Unity-iPhone.xcodeproj/project.pbxproj&#39;</span><span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="s">&#39;System/Library/Frameworks/CoreTelephony.framework&#39;</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="s">&#39;SDKROOT&#39;</span><span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="s">&#39;System/Library/Frameworks/MobileCoreServices.framework&#39;</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="s">&#39;SDKROOT&#39;</span><span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="s">&#39;System/Library/Frameworks/StoreKit.framework&#39;</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="s">&#39;SDKROOT&#39;</span><span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="s">&#39;System/Library/Frameworks/Social.framework&#39;</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="s">&#39;SDKROOT&#39;</span><span class="p">,</span> <span class="n">weak</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="s">&#39;usr/lib/libsqlite3.dylib&#39;</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="s">&#39;SDKROOT&#39;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;Step 2: add custom libraries and native code to xcode, exclude any .meta file&#39;</span><span class="p">)</span>
<span class="n">files_in_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">fileToAddPath</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_in_dir</span><span class="p">:</span>    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">):</span> <span class="c">#exclude .DS_STORE on mac</span>
    <span class="k">print</span> <span class="n">f</span>        
    <span class="n">pathname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileToAddPath</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="n">fileName</span><span class="p">,</span> <span class="n">fileExtension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fileExtension</span> <span class="o">==</span> <span class="s">&#39;.meta&#39;</span><span class="p">:</span> <span class="c">#skip .meta file</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pathname</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;is file : &quot;</span> <span class="o">+</span> <span class="n">pathname</span>
            <span class="n">project</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pathname</span><span class="p">):</span>
            <span class="k">print</span> <span class="s">&quot;is dir : &quot;</span> <span class="o">+</span> <span class="n">pathname</span>
            <span class="n">project</span><span class="o">.</span><span class="n">add_folder</span><span class="p">(</span><span class="n">pathname</span><span class="p">,</span> <span class="n">excludes</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;^.*\.meta$&quot;</span><span class="p">])</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;Step 3: modify the AppController&#39;</span><span class="p">)</span>
<span class="n">appcontroller</span><span class="o">.</span><span class="n">touch_implementation</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s">&#39;/Classes/AppController.mm&#39;</span><span class="p">)</span>
<span class="n">appcontroller</span><span class="o">.</span><span class="n">touch_header</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s">&#39;/Classes/AppController.h&#39;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;Step 4: change build setting&#39;</span><span class="p">)</span>
<span class="n">project</span><span class="o">.</span><span class="n">add_other_buildsetting</span><span class="p">(</span><span class="s">&#39;GCC_ENABLE_OBJC_EXCEPTIONS&#39;</span><span class="p">,</span> <span class="s">&#39;YES&#39;</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s">&#39;Step 5: save our change to xcode project file&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">modified</span><span class="p">:</span>
    <span class="n">project</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="n">project</span><span class="o">.</span><span class="n">saveFormat3_2</span><span class="p">()</span>
</code></pre></div>

<p>Code is pretty self-explanatory.</p>

<p>Because that we need to mess around with xcode project file, we better use some existing script to do it. And there is one I found which is pretty good: <a href="https://bitbucket.org/icalderon/mod-pbxproj">Mod PBXProj</a> (The script I refere here doesn&rsquo;t support change build setings and has some problem with escape library search path, you can download good one from my github). </p>

<p>The most complicted code would be in the Step 3, which we modified our AppController. This is place you probably do:</p>

<ul>
  <li>add instance variables delcarations in AppController.h</li>
  <li>add code snippet to begin of specfic method in AppController.mm</li>
  <li>add code snippet to end of specfic method in AppController.mm</li>
  <li>add methods to end of AppController.mm</li>
</ul>

<p>Because you probably need modify that file constantly, it would be great there is flexible and easy way to do it.</p>

<p>Let&rsquo;s look at part of <em>appcontroller.py</em>:</p>

<div class="highlight"><pre><code class="python"> 
    <span class="c">#!/usr/bin/python</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">process_app_controller_wrapper</span><span class="p">(</span><span class="n">appcontroller_filename</span><span class="p">,</span> <span class="n">newContent</span><span class="p">,</span> <span class="n">methodSignatures</span><span class="p">,</span> <span class="n">valuesToAppend</span><span class="p">,</span> <span class="n">positionsInMethod</span><span class="p">,</span> <span class="n">contentToAppend</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">appcontroller</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">appcontroller_filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">appcontroller</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">appcontroller</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>    
    <span class="n">foundIndex</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>         
        <span class="k">print</span> <span class="n">line</span>
        <span class="n">newContent</span> <span class="o">+=</span> <span class="n">line</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">methodSignatures</span><span class="p">):</span>
            <span class="k">print</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="n">val</span><span class="p">):</span>
                <span class="k">print</span> <span class="s">&quot;founded match method: &quot;</span> <span class="o">+</span> <span class="n">val</span>
                <span class="n">foundIndex</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">found</span> <span class="p">:</span>
            <span class="k">if</span> <span class="n">positionsInMethod</span><span class="p">[</span><span class="n">foundIndex</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;begin&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;{&#39;</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;add code to resign body&quot;</span>
                <span class="n">newContent</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">valuesToAppend</span><span class="p">[</span><span class="n">foundIndex</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">found</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">if</span> 	<span class="n">positionsInMethod</span><span class="p">[</span><span class="n">foundIndex</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;end&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;}&#39;</span><span class="p">:</span>
                <span class="n">newContent</span> <span class="o">=</span> <span class="n">newContent</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">newContent</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">valuesToAppend</span><span class="p">[</span><span class="n">foundIndex</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">newContent</span> <span class="o">+=</span> <span class="s">&quot;}</span><span class="se">\n</span><span class="s">&quot;</span>
                <span class="n">foundWillResignActive</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;@end&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">contentToAppend</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">newContent</span> <span class="o">=</span> <span class="n">newContent</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
                <span class="n">newContent</span> <span class="o">+=</span> <span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">contentToAppend</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">newContent</span> <span class="o">+=</span> <span class="s">&quot;@end&quot;</span>                        
            
    <span class="k">print</span> <span class="s">&quot;-------done loop close stream and content: &quot;</span> <span class="o">+</span> <span class="n">newContent</span>                   
    <span class="n">appcontroller</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">appcontroller_filename</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>    
    <span class="n">appcontroller</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">newContent</span><span class="p">)</span>
    <span class="n">appcontroller</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>        

<span class="k">def</span> <span class="nf">chartboostAndRevMob</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">    Chartboost *cb = [Chartboost sharedChartboost];</span>
<span class="s">    cb.appId = @&quot;XXXX&quot;;</span>
<span class="s">    cb.appSignature = @&quot;XXX&quot;;</span>
<span class="s">    [cb startSession];</span>
<span class="s">    [RevMobAds startSessionWithAppID:@&quot;XXXXX&quot;]; </span>
<span class="s">    &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">importHeaders</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">    #import &quot;Appirater.h&quot;</span>
<span class="s">    #import &quot;RDGameCenterManager.h&quot;</span>
<span class="s">    #import &quot;Chartboost.h&quot;</span>
<span class="s">    #import &lt;RevMobAds/RevMobAds.h&gt;</span>
<span class="s">    #import &quot;FlurryAnalytics.h&quot;</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">pushActionInstanceDeclaration</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">	NSString *deviceTokenString;</span>
<span class="s">	NSString *deviceAlias;</span>
<span class="s">	NSString *pushActionURL;    </span>
<span class="s">    &#39;&#39;&#39;</span>
<span class="k">def</span> <span class="nf">pushActionDealloc</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">    [deviceTokenString release];</span>
<span class="s">    [deviceAlias release];</span>
<span class="s">    [pushActionURL release];</span>
<span class="s">    &#39;&#39;&#39;</span>

<span class="k">def</span> <span class="nf">extraCodeToAddInAppControllerMMFile</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&#39;&#39;&#39;</span>
<span class="s">//blablabla</span>
<span class="s">- (void)connection:(NSURLConnection *)theConnection didFailWithError:(NSError *)error {</span>
<span class="s">    [UIApplication sharedApplication].networkActivityIndicatorVisible = NO;</span>
<span class="s">    UIAlertView *someError = [[UIAlertView alloc] initWithTitle:</span>
<span class="s">                              @&quot;Network error&quot; message: @&quot;Error registering with server&quot;</span>
<span class="s">													   delegate: self</span>
<span class="s">											  cancelButtonTitle: @&quot;Ok&quot;</span>
<span class="s">											  otherButtonTitles: nil];</span>
<span class="s">    [someError show];</span>
<span class="s">    [someError release];</span>
<span class="s">    NSLog(@&quot;ERROR: NSError query result: %@&quot;, error);</span>

<span class="s">}</span>

<span class="s">- (void)alertView:(UIAlertView *)alertView clickedButtonAtIndex:(NSInteger)buttonIndex</span>
<span class="s">{</span>
<span class="s">    NSLog(@&quot;alert button index </span><span class="si">%d</span><span class="s">&quot;, buttonIndex);</span>

<span class="s">    if(buttonIndex == 1)</span>
<span class="s">    {</span>
<span class="s">        //ok action</span>
<span class="s">        NSURL *url = [NSURL URLWithString:pushActionURL];</span>
<span class="s">        [[UIApplication sharedApplication] openURL:url];</span>
<span class="s">    }</span>

<span class="s">}</span>
<span class="s">//blablabla</span>
<span class="s">&#39;&#39;&#39;</span>
    
<span class="k">def</span> <span class="nf">touch_implementation</span><span class="p">(</span><span class="n">appcontroller_filename</span><span class="p">):</span>
    <span class="c"># appcontroller = open(appcontroller_filename, &#39;w&#39;)</span>
    <span class="c"># print(&quot; process AppController.mm add imports header&quot;)</span>
    <span class="n">newContent</span> <span class="o">=</span> <span class="n">importHeaders</span><span class="p">()</span>
     
    <span class="c">#starting line of method {</span>
    <span class="n">methodSignatures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#value to append near }</span>
    <span class="n">valueToAppend</span> <span class="o">=</span> <span class="p">[]</span>
	<span class="c">#position to add insert at the beginning o</span>
    <span class="n">positionsInMethod</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">methodSignatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;- (void)applicationWillEnterForeground:(UIApplication *)application&#39;</span><span class="p">)</span>
    <span class="n">valueToAppend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;[Appirater appEnteredForeground:YES];&#39;</span><span class="p">)</span>
    <span class="n">positionsInMethod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;end&quot;</span><span class="p">)</span>

    <span class="n">methodSignatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;- (void) applicationDidBecomeActive:(UIApplication*)application&#39;</span><span class="p">)</span>
    <span class="n">valueToAppend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chartboostAndRevMob</span><span class="p">())</span>        
    <span class="n">positionsInMethod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;end&quot;</span><span class="p">)</span>
    
    <span class="n">methodSignatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;- (void) dealloc&#39;</span><span class="p">)</span>
    <span class="n">valueToAppend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pushActionDealloc</span><span class="p">())</span>        
    <span class="n">positionsInMethod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;begin&quot;</span><span class="p">)</span>

    <span class="n">process_app_controller_wrapper</span><span class="p">(</span><span class="n">appcontroller_filename</span><span class="p">,</span> <span class="n">newContent</span><span class="p">,</span> <span class="n">methodSignatures</span><span class="p">,</span> <span class="n">valueToAppend</span><span class="p">,</span> <span class="n">positionsInMethod</span><span class="p">,</span> <span class="n">extraCodeToAddInAppControllerMMFile</span><span class="p">())</span>    

<span class="k">def</span> <span class="nf">touch_header</span><span class="p">(</span><span class="n">appcontroller_filename</span><span class="p">):</span>
    <span class="c"># appcontroller = open(appcontroller_filename, &#39;w&#39;)</span>
    <span class="c"># print(&quot; process AppController.mm add imports header&quot;)</span>
    <span class="n">newContent</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="c">#starting line of method {</span>
    <span class="n">methodSignatures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c">#value to append near }</span>
    <span class="n">valueToAppend</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">positionsInMethod</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">methodSignatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;@interface AppController : NSObject&lt;UIAccelerometerDelegate, UIApplicationDelegate&gt;&#39;</span><span class="p">)</span>
    <span class="n">valueToAppend</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pushActionInstanceDeclaration</span><span class="p">())</span>
    <span class="n">positionsInMethod</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;begin&quot;</span><span class="p">)</span>
    <span class="n">process_app_controller_wrapper</span><span class="p">(</span><span class="n">appcontroller_filename</span><span class="p">,</span> <span class="n">newContent</span><span class="p">,</span> <span class="n">methodSignatures</span><span class="p">,</span> <span class="n">valueToAppend</span><span class="p">,</span> <span class="n">positionsInMethod</span><span class="p">)</span>    
</code></pre></div>

<p>A breif explanation is given if you need to change it later.</p>

<ol>
  <li>
    <p>add code to begin/end of specfic method, you just need to copy the method signature and add to <em>methodSignatures.append(&lsquo;some method signature&rsquo;)</em></p>
  </li>
  <li>
    <p>if the code snippet is like one line you just do it like this <em>valueToAppend.append(&lsquo;[Appirater appEnteredForeground:YES];&rsquo;)</em> ; and if code snippet is pretty long, you better put it in method like <em>def pushActionInstanceDeclaration():</em> and append it like this <em>valueToAppend.append(pushActionInstanceDeclaration())</em></p>
  </li>
  <li>
    <p>to mark the position of begin/end like <em>positionsInMethod.append(&ldquo;begin/end&rdquo;)</em></p>
  </li>
  <li>
    <p>put content to append inside <em>extraCodeToAddInAppControllerMMFile</em> and pass it as fifth parameter of <em>process_app_controller_wrapper</em></p>
  </li>
</ol>

<p>There you go. You can put the code change in your <em>appcontroller.py</em> and it is pretty easy to make changes.</p>

<h2 id="fix-library-search-path">Fix Library Search Path</h2>
<p>When I build from unity and run it in xcode, I got bunch of errors. Among them , one says that</p>

<blockquote>
  <p>ld: library not found for -lChartboost</p>
</blockquote>

<blockquote>
  <p>ld: library not found for -lFlurryAnalytics</p>
</blockquote>

<p>But I double checked the chartboost and flurry analytics static lib are indeed imported and showed in Linked Libraries of build settings.After searched on Stackoverflow, I open the build setting of xcode by going to </p>

<pre><code>"Targets"-&gt; "Build Settings" -&gt; "Library Search Paths"
</code></pre>

<p>Then you will see following settings:</p>

<pre><code>"$(SRCROOT)"
"$(SRCROOT)/Libraries"
\"$(SRCROOT)/../../PigRush-iOS/Assets/ObjC/Chartboost\"
\"$(SRCROOT)/../../PigRush-iOS/Assets/ObjC/FlurryAnalytics\"
</code></pre>

<p>WTF! The paths pointing to our custom libraries are got <em>escaped</em>. 
Then I drill down the code of <em>mod_pbxproj.py</em>, and found following snippet: </p>

<div class="highlight"><pre><code class="python"><span class="k">def</span> <span class="nf">add_search_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
	<span class="n">modified</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c">#blabla</span>
	<span class="k">if</span> <span class="n">escape</span> <span class="p">:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">base</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\\</span><span class="s">&quot;</span><span class="si">%s</span><span class="se">\\</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">):</span><span class="c">#&#39;\\&quot;%s\\&quot;&#39; % path</span>
			<span class="n">modified</span> <span class="o">=</span> <span class="bp">True</span>
	<span class="k">else</span><span class="p">:</span>
		<span class="k">if</span> <span class="bp">self</span><span class="p">[</span><span class="n">base</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">path</span><span class="p">):</span><span class="c">#&#39;\\&quot;%s\\&quot;&#39; % path</span>
			<span class="n">modified</span> <span class="o">=</span> <span class="bp">True</span>
	<span class="k">return</span> <span class="n">modified</span>
</code></pre></div>

<p>which you probably notice the <em>escape</em> flag by default is set to <em>True</em>. Then I change that flag to <em>False</em>, that error was gone :)</p>

<h2 id="done--not-yet">Done ? Not Yet</h2>
<p>But I still got lots errors in Xcode and no clue aobut what&rsquo;s going wrong. Until that I found there is another PostBuildProcess script from <a href="http://www.kamcord.com/">Kamcord</a>. Kamcord is unity package we imported for use of record and share mobile gameplay video. </p>

<p>Kamcord also has PostBuildProcess script under Assets/Editor folder, which is like following:</p>

<div class="highlight"><pre><code class="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">KamcordPostprocessScript</span> <span class="p">:</span> <span class="n">MonoBehaviour</span>
<span class="p">{</span>

	<span class="c1">// Replaces PostprocessBuildPlayer functionality</span>
<span class="na">	[PostProcessBuild]</span>
	<span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">OnPostprocessBuild</span><span class="p">(</span><span class="n">BuildTarget</span> <span class="n">target</span><span class="p">,</span> <span class="kt">string</span> <span class="n">pathToBuildProject</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">UnityEngine</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span> <span class="p">(</span><span class="s">&quot;--- Kamcord --- Executing post process build phase.&quot;</span><span class="p">);</span>		
		<span class="n">Process</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Process</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="s">&quot;perl&quot;</span><span class="p">;</span>
        <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">Arguments</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="s">&quot;Assets/Editor/KamcordPostprocessbuildPlayer1 \&quot;{0}\&quot;&quot;</span><span class="p">,</span> <span class="n">pathToBuildProject</span><span class="p">);</span>
        <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">UseShellExecute</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">p</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">RedirectStandardOutput</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">p</span><span class="p">.</span><span class="n">Start</span><span class="p">();</span>		
        <span class="n">p</span><span class="p">.</span><span class="n">WaitForExit</span><span class="p">();</span>		
		<span class="n">UnityEngine</span><span class="p">.</span><span class="n">Debug</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="s">&quot;--- Kamcord --- Finished executing post process build phase.&quot;</span><span class="p">);</span> 
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>It just executes a perl script, which basically just add Kamcord.framework and related resources to xcode.</p>

<p>Let&rsquo;s look the <em>Link Library With Libraries</em>, we found that Kamcord.framework is missing! But if we remove our custom script, it is showing.</p>

<p>Now we had two post build process scripts. Pretty bad, as we dont&rsquo; know the order it will get executed. And the problem that Kamdcord.framework is missing, maybe is because of orders of execution of scripts.</p>

<p>By taking a look at logs of Unity app, we found actually our <em>CustomPostprocessScript.cs</em> runs before <em>KamcordPostprocessScript.cs</em>. (I will talk about how to check the logs from <em>print</em> in python and <em>UnityEngine.Debug.Log</em> in Unity, which it is handy when debugging).</p>

<p>What I want to do here is make sure our custom script always run after other scripts. Because if we execute our script first, then we have no idea what other script is gonna modify, which possibily screws up everything.</p>

<p>Is there any way specify the order of execution of script ? Yes, from <a href="http://www.ikriz.nl/2012/06/18/unity-post-process-mayhem/">Unity Post Process Mayhem</a>, I found that </p>

<pre><code>[PostProcessBuild(0)] // &lt;- this is where the magic happens
public static void OnPostProcessBuildFirst(BuildTarget target, string path)
{
    Debug.Log("I get Executed First");
}
</code></pre>

<blockquote>
  <p>NB: -10 is a higher priority than 100, the default priority is 1</p>
</blockquote>

<p>Cool, then we can go back to our <em>CustomPostprocessScript.cs</em> and modify <em>[PostProcessBuild]</em> to <em>[PostProcessBuild(100)]</em>. Then we make sure our script always run after other scripts.</p>

<p>You can see the benefits of coding our post process in a sepearate file. By doing this way, we make sure when we update other package like Kamcord, no matter when they change in their script, it won&rsquo;t affect our custom script.</p>

<h2 id="tips">Tips</h2>
<p>To look the logs of post build process scripts, like <em>print</em> in python, you can follow steps: </p>

<pre><code>open *Console* from spotlight --&gt; left panel FILES *~/Library/Logs* --&gt; expand to *Unity* --&gt; click *Editor.log*
</code></pre>

<p>Then you can see logs of Unity. It is also quite usefull when the Unity is freezing, and you want know whether it is really &lsquo;dead&rsquo;.  </p>

<p>Because the xcode project when built from Unity is like 768 M, and it takes Unity 5~10 minutes to build out, which make the process extremely painful.</p>

<p>I&rsquo;d like to suggest when testing python script, you probably just move a clean copy of AppController or pbproject file to another folder with git supported. Then you can test your script separately without everytime build from Unity.</p>

<p>Python is quite straightford to pick up, like I just spend several mintues to get familiar with its syntax and be able work on it quite easily. BTW, pay attention to the soft tabs and hard tabs when you get indentation problems.</p>

<p>You can have a complete source code here:<a href="https://github.com/tuo/UnityAutomatePostProcess">UnityAutomatePostProcess</a>.</p>

<p>Enjoy unity!</p>


  </div>
  <hr style="visibility:hidden;"/>
  
  <!--<footer class="ten columns">
    <p id='follow'>
       Follow me on <a href="http://twitter.com/tu0huang">Twitter</a> &
       <a href="http://weibo.com/tu0huang">Weibo</a>	   
    </p>
  </footer> -->
</article>

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style ten columns offset-by-four" style="margin-bottom: 11px;">
	<a class="addthis_counter addthis_pill_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":true};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-50f9651243f1723a"></script>
<!-- AddThis Button END -->
<div style="margin-bottom:10px;"/>
<div id="disqus_thread" class="ten columns offset-by-four"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'tuohuang'; // required: replace example with your forum shortname
  var disqus_identifier = '/tuohuangid';
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </div>
  </body>
</html> 